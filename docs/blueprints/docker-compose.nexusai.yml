version: "3.9"

networks:
  nexusai:
    driver: bridge

volumes:
  postgres_data:
  redis_data:
  kafka_data:

services:
  postgres:
    image: pgvector/pgvector:pg16
    environment:
      POSTGRES_DB: nexusai
      POSTGRES_USER: nexusai
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-nexusai_dev_password}
    ports: ["5432:5432"]
    networks: [nexusai]

  redis:
    image: redis:7-alpine
    command: redis-server --requirepass ${REDIS_PASSWORD:-redis_dev_password}
    ports: ["6379:6379"]
    networks: [nexusai]

  zookeeper:
    image: confluentinc/cp-zookeeper:7.5.0
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
    networks: [nexusai]

  kafka:
    image: confluentinc/cp-kafka:7.5.0
    depends_on: [zookeeper]
    ports: ["9092:9092"]
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:29092,PLAINTEXT_HOST://localhost:9092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
    networks: [nexusai]

  gateway:
    image: nexusai/gateway:dev
    ports: ["8000:8000"]
    environment:
      API_URL: http://api:8001
      REDIS_URL: redis://:${REDIS_PASSWORD:-redis_dev_password}@redis:6379
    depends_on: [redis]
    networks: [nexusai]

  api:
    image: nexusai/api:dev
    ports: ["8001:8001"]
    environment:
      DATABASE_URL: postgresql+asyncpg://nexusai:${POSTGRES_PASSWORD:-nexusai_dev_password}@postgres:5432/nexusai
      REDIS_URL: redis://:${REDIS_PASSWORD:-redis_dev_password}@redis:6379
      KAFKA_BOOTSTRAP_SERVERS: kafka:29092
    depends_on: [postgres, redis]
    networks: [nexusai]
